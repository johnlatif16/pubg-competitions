<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>لوحة التحكم | إدارة التسجيلات</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-primary: #0c1427;
      --bg-card: #1a233a;
      --border: #2a3a62;
      --accent: #4f7cff;
      --accent-hover: #3a6bff;
      --text-primary: #e9eefc;
      --text-secondary: #a0b3ff;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, 'Noto Sans Arabic', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0a1120 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .dashboard-container { display: flex; flex-direction: column; min-height: 100vh; }

    .dashboard-header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(90deg, var(--accent), var(--text-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(79, 124, 255, 0.1);
      padding: 10px 18px;
      border-radius: 50px;
      border: 1px solid rgba(79, 124, 255, 0.3);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(90deg, var(--accent), #6b93ff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .header-right { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }

    .badge-status {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(10, 15, 30, 0.5);
      color: var(--text-secondary);
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .dashboard-content {
      flex: 1;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-5px); }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }
    .stat-icon.blue { background: rgba(79, 124, 255, 0.15); color: var(--accent); }
    .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }

    .stat-info h3 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
    .stat-value { font-size: 2rem; font-weight: 800; }

    .controls {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .search-box { position: relative; flex: 1; min-width: 300px; }

    .search-box input {
      width: 100%;
      padding: 16px 20px 16px 50px;
      background: rgba(10, 15, 30, 0.7);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79, 124, 255, 0.2);
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.5);
    }

    .btn {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary { background: linear-gradient(90deg, var(--accent), #6b93ff); color: white; }
    .btn-primary:hover {
      background: linear-gradient(90deg, var(--accent-hover), #5a83ff);
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(79, 124, 255, 0.3);
    }

    .btn-secondary { background: transparent; color: var(--text-secondary); border: 2px solid var(--border); }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.05); border-color: var(--accent); }

    .btn-danger { background: linear-gradient(90deg, #ef4444, #ff6b6b); color: white; }
    .btn-danger:hover {
      background: linear-gradient(90deg, #dc2626, #ef4444);
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(239, 68, 68, 0.3);
    }

    .table-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 0;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(10, 15, 30, 0.8); border-bottom: 2px solid var(--border); }

    th {
      padding: 20px;
      text-align: right;
      font-weight: 700;
      color: var(--text-secondary);
      font-size: 0.95rem;
      white-space: nowrap;
    }

    tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: background 0.3s ease; }
    tbody tr:hover { background: rgba(79, 124, 255, 0.05); }

    td { padding: 18px 20px; text-align: right; font-size: 0.95rem; vertical-align: top; }

    .player-names { max-width: 280px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .actions-cell { white-space: nowrap; }
    .action-buttons { display: flex; gap: 10px; }
    .btn-small { padding: 8px 14px; font-size: 0.85rem; border-radius: 8px; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state i { font-size: 3rem; margin-bottom: 20px; opacity: 0.5; }

    @media (max-width: 1200px) {
      .dashboard-content { padding: 20px; }
      .table-container { overflow-x: auto; }
      table { min-width: 900px; }
    }

    @media (max-width: 992px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .controls { flex-direction: column; align-items: stretch; }
      .search-box { min-width: 100%; }
      .header-right { justify-content: center; }
    }

    @media (max-width: 768px) {
      .dashboard-header { flex-direction: column; text-align: center; padding: 20px; }
      .header-left { flex-direction: column; }
      .stats-grid { grid-template-columns: 1fr; }
      th, td { padding: 15px 10px; }
      .action-buttons { flex-direction: column; }
    }

    .glow-effect {
      position: fixed;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(79, 124, 255, 0.05) 0%, transparent 70%);
      z-index: -1;
    }
    .glow-1 { top: 10%; right: 5%; }
    .glow-2 { bottom: 10%; left: 5%; }
  </style>
</head>

<body>
  <div class="glow-effect glow-1"></div>
  <div class="glow-effect glow-2"></div>

  <div class="dashboard-container">
    <header class="dashboard-header">
      <div class="header-left">
        <h1 class="logo"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h1>

        <div class="user-info">
          <div class="user-avatar">أ</div>
          <div>
            <div style="font-weight: 700;">الأدمن</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">مدير النظام</div>
          </div>
        </div>
      </div>

      <div class="header-right">
        <span class="badge-status" id="status">
          <i class="fas fa-circle-notch fa-spin"></i> جاري التحقق...
        </span>

        <button id="btnRefresh" class="btn btn-primary">
          <i class="fas fa-sync-alt"></i> تحديث البيانات
        </button>
        <button id="btnCSV" class="btn btn-secondary">
          <i class="fas fa-file-export"></i> تصدير CSV
        </button>
        <button id="btnLogout" class="btn btn-danger">
          <i class="fas fa-sign-out-alt"></i> تسجيل خروج
        </button>
      </div>
    </header>

    <main class="dashboard-content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue"><i class="fas fa-users"></i></div>
          <div class="stat-info">
            <h3>إجمالي المسجلين</h3>
            <div class="stat-value" id="totalCount">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon orange"><i class="fas fa-calendar-day"></i></div>
          <div class="stat-info">
            <h3>المسجلين اليوم</h3>
            <div class="stat-value" id="todayCount">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon green"><i class="fas fa-user-check"></i></div>
          <div class="stat-info">
            <h3>المعروض الآن</h3>
            <div class="stat-value" id="shownCount">0</div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="search-box">
          <input type="text" id="q" placeholder="ابحث بالاسم، الموبايل، ID، أسماء اللاعبين...">
          <div class="search-icon"><i class="fas fa-search"></i></div>
        </div>
        <div id="stats" style="color: var(--text-secondary);">جاري التحميل...</div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>التاريخ والوقت</th>
              <th>الاسم الكامل</th>
              <th>رقم الموبايل</th>
              <th>ID اللعبة</th>
              <th>أسماء اللاعبين</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td colspan="6">
                <div class="empty-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  <div>جاري تحميل البيانات...</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    const tbody = document.getElementById("tbody");
    const statsEl = document.getElementById("stats");
    const statusEl = document.getElementById("status");
    const q = document.getElementById("q");

    const totalCount = document.getElementById("totalCount");
    const todayCount = document.getElementById("todayCount");
    const shownCount = document.getElementById("shownCount");

    let allRows = [];

    function esc(s) {
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[c]));
    }

    function fmtDate(ms) {
      if (!ms) return "";
      return new Date(ms).toLocaleString("ar-EG");
    }

    function formatPhone(phone) {
      if (!phone) return "";
      const p = String(phone);
      // تنسيق بسيط لو مصري 11 رقم: 010-1234-5678
      return p.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
    }

    function setStatusOk(text) {
      statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ' + esc(text);
      statusEl.style.color = "var(--success)";
      statusEl.style.borderColor = "rgba(16,185,129,0.35)";
      statusEl.style.background = "rgba(16,185,129,0.10)";
    }

    function setStatusErr(text) {
      statusEl.innerHTML = '<i class="fas fa-times-circle"></i> ' + esc(text);
      statusEl.style.color = "var(--error)";
      statusEl.style.borderColor = "rgba(239,68,68,0.35)";
      statusEl.style.background = "rgba(239,68,68,0.10)";
    }

    async function apiGet(url) {
      const res = await fetch(url, { credentials: "include" });
      const txt = await res.text();
      let out;
      try { out = JSON.parse(txt); }
      catch { out = { error: txt || "Non-JSON response" }; }
      return { res, out };
    }

    async function apiDelete(url) {
      const res = await fetch(url, { method: "DELETE", credentials: "include" });
      const txt = await res.text();
      let out;
      try { out = JSON.parse(txt); }
      catch { out = { error: txt || "Non-JSON response" }; }
      return { res, out };
    }

    async function ensureAuth() {
      const { res } = await apiGet("/api/me");
      if (!res.ok) {
        setStatusErr("غير مسجل دخول");
        location.href = "/login.html";
        return false;
      }
      setStatusOk("مسجل دخول");
      return true;
    }

    async function loadRows() {
      tbody.innerHTML = `
        <tr>
          <td colspan="6">
            <div class="empty-state">
              <i class="fas fa-spinner fa-spin"></i>
              <div>جاري تحميل البيانات...</div>
            </div>
          </td>
        </tr>
      `;

      const { res, out } = await apiGet("/api/registrations");
      if (!res.ok) {
        setStatusErr(out.error || "غير مصرح");
        location.href = "/login.html";
        return;
      }

      allRows = out.rows || [];
      render();
    }

    function render() {
      const needle = q.value.trim().toLowerCase();
      const rows = !needle ? allRows : allRows.filter(r => {
        const blob = [r.fullName, r.phone, r.gameId, r.notes].join(" ").toLowerCase();
        return blob.includes(needle);
      });

      totalCount.textContent = allRows.length;
      shownCount.textContent = rows.length;

      const todayStart = new Date();
      todayStart.setHours(0,0,0,0);
      const todayMs = +todayStart;
      const todayRows = allRows.filter(r => {
        const d = new Date(r.createdAtMs || 0);
        d.setHours(0,0,0,0);
        return +d === todayMs;
      });
      todayCount.textContent = todayRows.length;

      statsEl.textContent = `عرض ${rows.length} من ${allRows.length} تسجيل`;

      if (!rows.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-search"></i>
                <div>لا توجد نتائج تطابق بحثك</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${esc(fmtDate(r.createdAtMs))}</td>
          <td><strong>${esc(r.fullName)}</strong></td>
          <td><i class="fas fa-phone" style="margin-left: 8px; opacity: 0.7;"></i> ${esc(formatPhone(r.phone))}</td>
          <td><code style="background: rgba(79,124,255,0.1); padding: 5px 10px; border-radius: 6px;">${esc(r.gameId)}</code></td>
          <td class="player-names" title="${esc(r.notes)}">${esc(r.notes)}</td>
          <td class="actions-cell">
            <div class="action-buttons">
              <button class="btn btn-secondary btn-small" onclick="viewDetails('${esc(r.id)}')">
                <i class="fas fa-eye"></i> عرض
              </button>
              <button class="btn btn-danger btn-small" onclick="deleteRow('${esc(r.id)}')">
                <i class="fas fa-trash"></i> حذف
              </button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    async function deleteRow(id) {
      if (!id) return;
      const ok = confirm("هل أنت متأكد من حذف هذا التسجيل؟ لا يمكن التراجع.");
      if (!ok) return;

      const { res, out } = await apiDelete("/api/registration?id=" + encodeURIComponent(id));
      if (!res.ok) {
        alert(out.error || "فشل الحذف");
        return;
      }
      await loadRows();
    }

    function viewDetails(id) {
      const row = allRows.find(r => r.id === id);
      if (!row) return;

      alert(
        `تفاصيل التسجيل:\n\n` +
        `الاسم: ${row.fullName}\n` +
        `الهاتف: ${row.phone}\n` +
        `ID اللعبة: ${row.gameId}\n` +
        `أسماء اللاعبين: ${row.notes}\n` +
        `تاريخ التسجيل: ${fmtDate(row.createdAtMs)}`
      );
    }

    function toCSV(rows) {
      const header = ["التاريخ","الاسم","الهاتف","ID اللعبة","أسماء اللاعبين"];
      const lines = [header.join(",")];
      for (const r of rows) {
        const line = [
          fmtDate(r.createdAtMs),
          r.fullName,
          r.phone,
          r.gameId,
          r.notes
        ].map(v => `"${String(v ?? "").replace(/"/g,'""')}"`).join(",");
        lines.push(line);
      }
      return lines.join("\n");
    }

    document.getElementById("btnRefresh").onclick = async () => {
      await loadRows();
    };

    document.getElementById("btnCSV").onclick = () => {
      const csv = toCSV(allRows);
      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `تسجيلات_${new Date().toLocaleDateString("ar-EG")}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById("btnLogout").onclick = async () => {
      await fetch("/api/logout", { credentials: "include" });
      location.href = "/login.html";
    };

    q.addEventListener("input", render);

    (async () => {
      if (await ensureAuth()) {
        await loadRows();
      }
    })();
  </script>
</body>
</html>
