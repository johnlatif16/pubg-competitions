<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دخول الأدمن</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#0b1220; color:#e9eefc}
    .wrap{max-width:520px; margin:0 auto; padding:28px}
    .card{background:#121a2c; border:1px solid #263252; border-radius:14px; padding:18px}
    h2{margin:0 0 10px}
    label{display:block; font-size:14px; opacity:.9; margin:10px 0 6px}
    input{width:100%; padding:12px; border-radius:10px; border:1px solid #2a3a62; background:#0c1427; color:#e9eefc}
    button{margin-top:14px; width:100%; padding:12px 16px; border-radius:12px; border:0; background:#4f7cff; color:white; font-weight:700; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .msg{margin-top:12px; padding:12px; border-radius:12px; display:none; white-space:pre-wrap}
    .err{background:#2a1010; border:1px solid #7a2222}
    .ok{background:#0f2a1b; border:1px solid #1f6a3a}
    .muted{opacity:.75; font-size:13px; margin-top:10px; line-height:1.6}
    a{color:#9fb7ff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>دخول الأدمن</h2>

      <form id="loginForm" autocomplete="off">
        <label for="user">اسم المستخدم</label>
        <input id="user" name="user" type="text" required placeholder="USERNAME" />

        <label for="password">كلمة المرور</label>
        <input id="password" name="password" type="password" required placeholder="PASSWORD" />

        <button id="btn" type="submit">دخول</button>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>

        <div class="muted">
          هذه الصفحة مخصصة لمسؤولي النظام فقط.
        </div>
      </form>
    </div>
  </div>

  <script>
    const form = document.getElementById("loginForm");
    const btn = document.getElementById("btn");
    const okBox = document.getElementById("msgOk");
    const errBox = document.getElementById("msgErr");

    function show(box, text) { box.textContent = text; box.style.display = "block"; }
    function hide(box){ box.style.display = "none"; }

    async function alreadyLoggedIn() {
      // لو التوكن موجود وصالح -> روح للداشبورد
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        if (res.ok) location.href = "/dashboard.html";
      } catch {}
    }

    alreadyLoggedIn();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(okBox); hide(errBox);

      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = "جاري تسجيل الدخول...";

      try {
        const data = Object.fromEntries(new FormData(form).entries());

        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ user: data.user, password: data.password })
        });

        const txt = await res.text();
        let out;
        try { out = JSON.parse(txt); }
        catch { out = { error: txt || "Non-JSON response" }; }

        if (!res.ok) throw new Error(out.error || "بيانات غير صحيحة");

        show(okBox, "✅ تم تسجيل الدخول بنجاح");
        setTimeout(() => (location.href = "/dashboard.html"), 250);

      } catch (err) {
        show(errBox, "❌ " + (err.message || "حدث خطأ"));
      } finally {
        btn.disabled = false;
        btn.textContent = oldText;
      }
    });
  </script>
</body>
</html>
