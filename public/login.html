<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دخول الأدمن</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#0b1220; color:#e9eefc}
    .wrap{max-width:520px; margin:0 auto; padding:28px}
    .card{background:#121a2c; border:1px solid #263252; border-radius:14px; padding:18px}
    h2{margin:0 0 10px}
    label{display:block; font-size:14px; opacity:.9; margin:10px 0 6px}
    input{width:100%; padding:12px; border-radius:10px; border:1px solid #2a3a62; background:#0c1427; color:#e9eefc}
    button{margin-top:14px; width:100%; padding:12px 16px; border-radius:12px; border:0; background:#4f7cff; color:white; font-weight:700; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .msg{margin-top:12px; padding:12px; border-radius:12px; display:none; white-space:pre-wrap}
    .err{background:#2a1010; border:1px solid #7a2222}
    .ok{background:#0f2a1b; border:1px solid #1f6a3a}
    a{color:#9fb7ff}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h2>دخول الأدمن</h2>

      <!-- فورم الدخول -->
      <form id="loginForm" autocomplete="off">
        <label>اسم المستخدم</label>
        <input name="user" type="text" required placeholder="USERNAME" />

        <label>كلمة المرور</label>
        <input name="password" type="password" required placeholder="PASSWORD" />

        <button id="btn" type="submit">دخول</button>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>
      </form>

      <!-- ✅ زرّين فقط ظاهرين -->
      <hr style="margin:20px 0; border-color:#263252">
      <button id="btnToggleUser" type="button">تغيير اسم المستخدم</button>
      <button id="btnTogglePass" type="button">تغيير كلمة السر</button>

      <!-- ✅ البيانات مخفية: تغيير اسم المستخدم -->
      <div id="userBox" style="display:none; margin-top:10px;">
        <label>الكود السري</label>
        <input id="u_resetKey" type="password" placeholder="RESET KEY" />

        <label>الباسورد الحالي</label>
        <input id="u_currentPass" type="password" placeholder="CURRENT PASSWORD" />

        <label>اسم المستخدم الجديد</label>
        <input id="u_newUser" type="text" placeholder="NEW USERNAME" />

        <button id="saveUser" type="button">حفظ اسم المستخدم</button>
      </div>

      <!-- ✅ البيانات مخفية: تغيير كلمة السر -->
      <div id="passBox" style="display:none; margin-top:10px;">
        <label>الكود السري</label>
        <input id="p_resetKey" type="password" placeholder="RESET KEY" />

        <label>الباسورد الحالي</label>
        <input id="p_currentPass" type="password" placeholder="CURRENT PASSWORD" />

        <label>الباسورد الجديد</label>
        <input id="p_newPass" type="password" placeholder="NEW PASSWORD (min 8 chars)" />

        <button id="savePass" type="button">حفظ كلمة السر</button>
      </div>

    </div>
  </div>

  <script>
    const form = document.getElementById("loginForm");
    const btn = document.getElementById("btn");
    const okBox = document.getElementById("msgOk");
    const errBox = document.getElementById("msgErr");

    function show(box, text) { box.textContent = text; box.style.display = "block"; }
    function hide(box){ box.style.display = "none"; }

    // toggle sections
    const btnToggleUser = document.getElementById("btnToggleUser");
    const btnTogglePass = document.getElementById("btnTogglePass");
    const userBox = document.getElementById("userBox");
    const passBox = document.getElementById("passBox");

    btnToggleUser.addEventListener("click", () => {
      hide(okBox); hide(errBox);
      passBox.style.display = "none";
      userBox.style.display = (userBox.style.display === "none" ? "block" : "none");
    });

    btnTogglePass.addEventListener("click", () => {
      hide(okBox); hide(errBox);
      userBox.style.display = "none";
      passBox.style.display = (passBox.style.display === "none" ? "block" : "none");
    });

    // تسجيل الدخول
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(okBox); hide(errBox);
      btn.disabled = true;

      try {
        const data = Object.fromEntries(new FormData(form).entries());

        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ user: data.user, password: data.password })
        });

        const txt = await res.text();
        let out;
        try { out = JSON.parse(txt); }
        catch { out = { error: txt || "Non-JSON response" }; }

        if (!res.ok) throw new Error(out.error || "بيانات غير صحيحة");

        show(okBox, "✅ تم تسجيل الدخول بنجاح");
        setTimeout(() => (location.href = "/dashboard.html"), 250);

      } catch (err) {
        show(errBox, "❌ " + (err.message || "حدث خطأ"));
      } finally {
        btn.disabled = false;
      }
    });

    // تغيير اسم المستخدم (حل RESET_KEY بدون تسجيل دخول)
    const saveUser = document.getElementById("saveUser");
    saveUser.addEventListener("click", async () => {
      hide(okBox); hide(errBox);
      saveUser.disabled = true;

      try {
        const resetKey = document.getElementById("u_resetKey").value;
        const currentPassword = document.getElementById("u_currentPass").value;
        const newUser = document.getElementById("u_newUser").value;

        const res = await fetch("/api/admin/username", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ resetKey, currentPassword, newUser })
        });

        const out = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(out.error || "فشل تغيير اسم المستخدم");

        show(okBox, "✅ تم تغيير اسم المستخدم بنجاح");
        // تنظيف
        document.getElementById("u_currentPass").value = "";
        document.getElementById("u_newUser").value = "";
        // (اختياري) تسيب resetKey أو تمسحه:
        // document.getElementById("u_resetKey").value = "";
        userBox.style.display = "none";

      } catch (err) {
        show(errBox, "❌ " + (err.message || "حدث خطأ"));
      } finally {
        saveUser.disabled = false;
      }
    });

    // تغيير كلمة السر (حل RESET_KEY بدون تسجيل دخول)
    const savePass = document.getElementById("savePass");
    savePass.addEventListener("click", async () => {
      hide(okBox); hide(errBox);
      savePass.disabled = true;

      try {
        const resetKey = document.getElementById("p_resetKey").value;
        const currentPassword = document.getElementById("p_currentPass").value;
        const newPassword = document.getElementById("p_newPass").value;

        const res = await fetch("/api/admin/password", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ resetKey, currentPassword, newPassword })
        });

        const out = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(out.error || "فشل تغيير كلمة السر");

        show(okBox, "✅ تم تغيير كلمة السر بنجاح");
        // تنظيف
        document.getElementById("p_currentPass").value = "";
        document.getElementById("p_newPass").value = "";
        // (اختياري) تسيب resetKey أو تمسحه:
        // document.getElementById("p_resetKey").value = "";
        passBox.style.display = "none";

      } catch (err) {
        show(errBox, "❌ " + (err.message || "حدث خطأ"));
      } finally {
        savePass.disabled = false;
      }
    });
  </script>
</body>
</html>
