<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>دخول الأدمن</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#0b1220; color:#e9eefc}
    .wrap{max-width:520px; margin:0 auto; padding:28px}
    .card{background:#121a2c; border:1px solid #263252; border-radius:14px; padding:18px}
    h2{margin:0 0 10px}
    label{display:block; font-size:14px; opacity:.9; margin:10px 0 6px}
    input{width:100%; padding:12px; border-radius:10px; border:1px solid #2a3a62; background:#0c1427; color:#e9eefc}
    button{margin-top:14px; width:100%; padding:12px 16px; border-radius:12px; border:0; background:#4f7cff; color:white; font-weight:700; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .msg{margin-top:12px; padding:12px; border-radius:12px; display:none; white-space:pre-wrap}
    .err{background:#2a1010; border:1px solid #7a2222}
    .ok{background:#0f2a1b; border:1px solid #1f6a3a}
    a{color:#9fb7ff}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h2>دخول الأدمن</h2>

      <form id="loginForm" autocomplete="off">
        <label>اسم المستخدم</label>
        <input name="user" type="text" required placeholder="USERNAME" />

        <label>كلمة المرور</label>
        <input name="password" type="password" required placeholder="PASSWORD" />

        <button id="btn" type="submit">دخول</button>

        <div id="msgOk" class="msg ok"></div>
        <div id="msgErr" class="msg err"></div>
      </form>

      <!-- ✅ NEW: تغيير اليوزر / الباسورد (نفس الستايل) -->
      <div id="adminTools" style="display:none; margin-top:14px;">
        <button id="openUserBox" type="button">تغيير اسم المستخدم</button>
        <button id="openPassBox" type="button">تغيير الباسورد</button>

        <!-- تغيير اسم المستخدم -->
        <div id="userBox" style="display:none; margin-top:10px;">
          <label>الباسورد الحالي</label>
          <input id="u_currentPass" type="password" placeholder="CURRENT PASSWORD" />

          <label>اسم المستخدم الجديد</label>
          <input id="u_newUser" type="text" placeholder="NEW USERNAME" />

          <button id="saveUser" type="button">حفظ اسم المستخدم</button>
        </div>

        <!-- تغيير الباسورد -->
        <div id="passBox" style="display:none; margin-top:10px;">
          <label>الباسورد الحالي</label>
          <input id="p_currentPass" type="password" placeholder="CURRENT PASSWORD" />

          <label>الباسورد الجديد</label>
          <input id="p_newPass" type="password" placeholder="NEW PASSWORD (min 8 chars)" />

          <button id="savePass" type="button">حفظ الباسورد</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("loginForm");
    const btn = document.getElementById("btn");
    const okBox = document.getElementById("msgOk");
    const errBox = document.getElementById("msgErr");

    const adminTools = document.getElementById("adminTools");
    const openUserBox = document.getElementById("openUserBox");
    const openPassBox = document.getElementById("openPassBox");
    const userBox = document.getElementById("userBox");
    const passBox = document.getElementById("passBox");

    const saveUser = document.getElementById("saveUser");
    const savePass = document.getElementById("savePass");

    function show(box, text) { box.textContent = text; box.style.display = "block"; }
    function hide(box){ box.style.display = "none"; }

    function showTools() { adminTools.style.display = "block"; }
    function toggle(el) { el.style.display = (el.style.display === "none" ? "block" : "none"); }

    // ✅ لو الأدمن بالفعل داخل (token cookie) نظهر أدوات التغيير
    (async () => {
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        if (res.ok) showTools();
      } catch {}
    })();

    openUserBox.addEventListener("click", () => {
      hide(okBox); hide(errBox);
      passBox.style.display = "none";
      toggle(userBox);
    });

    openPassBox.addEventListener("click", () => {
      hide(okBox); hide(errBox);
      userBox.style.display = "none";
      toggle(passBox);
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(okBox); hide(errBox);
      btn.disabled = true;

      try {
        const data = Object.fromEntries(new FormData(form).entries());

        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ user: data.user, password: data.password })
        });

        const txt = await res.text();
        let out;
        try { out = JSON.parse(txt); }
        catch { out = { error: txt || "Non-JSON response" }; }

        if (!res.ok) throw new Error(out.error || "بيانات غير صحيحة");

        show(okBox, "✅ تم تسجيل الدخول بنجاح");
        showTools(); // ✅ بعد تسجيل الدخول نظهر أدوات التغيير

        setTimeout(() => (location.href = "/dashboard.html"), 250);

      } catch (err) {
        show(errBox, "❌ " + err.message);
      } finally {
        btn.disabled = false;
      }
    });

    // ✅ تغيير اسم المستخدم
    saveUser.addEventListener("click", async () => {
      hide(okBox); hide(errBox);
      saveUser.disabled = true;

      try {
        const currentPassword = document.getElementById("u_currentPass").value;
        const newUser = document.getElementById("u_newUser").value;

        const res = await fetch("/api/admin/username", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ currentPassword, newUser })
        });

        const txt = await res.text();
        let out;
        try { out = JSON.parse(txt); }
        catch { out = { error: txt || "Non-JSON response" }; }

        if (!res.ok) throw new Error(out.error || "فشل تغيير اسم المستخدم");

        show(okBox, "✅ تم تغيير اسم المستخدم بنجاح");
        document.getElementById("u_currentPass").value = "";
        document.getElementById("u_newUser").value = "";
        userBox.style.display = "none";

      } catch (err) {
        show(errBox, "❌ " + (err.message || "حدث خطأ"));
      } finally {
        saveUser.disabled = false;
      }
    });

    // ✅ تغيير الباسورد
    savePass.addEventListener("click", async () => {
      hide(okBox); hide(errBox);
      savePass.disabled = true;

      try {
        const currentPassword = document.getElementById("p_currentPass").value;
        const newPassword = document.getElementById("p_newPass").value;

        const res = await fetch("/api/admin/password", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ currentPassword, newPassword })
        });

        const txt = await res.text();
        let out;
        try { out = JSON.parse(txt); }
        catch { out = { error: txt || "Non-JSON response" }; }

        if (!res.ok) throw new Error(out.error || "فشل تغيير الباسورد");

        show(okBox, "✅ تم تغيير الباسورد بنجاح");
        document.getElementById("p_currentPass").value = "";
        document.getElementById("p_newPass").value = "";
        passBox.style.display = "none";

      } catch (err) {
        show(errBox, "❌ " + (err.message || "حدث خطأ"));
      } finally {
        savePass.disabled = false;
      }
    });
  </script>
</body>
</html>
